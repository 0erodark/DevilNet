<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Limits // Network Control</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        accent: 'var(--accent-color)',
                        surface: 'var(--surface-color)',
                        background: 'var(--bg-color)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-color: #09090b;
            --surface-color: rgba(24, 24, 27, 0.6);
            --accent-color: #3b82f6;
            /* Blue-500 */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        /* Themes */
        body.theme-nexus {
            --bg-color: #0f172a;
            /* Slate 900 */
            --surface-color: rgba(30, 41, 59, 0.7);
            --accent-color: #06b6d4;
            /* Cyan 500 */
        }

        body.theme-cyber {
            --bg-color: #050505;
            --surface-color: rgba(20, 20, 20, 0.8);
            --accent-color: #00ff41;
            --text-primary: #e2e8f0;
        }

        body.theme-sunset {
            --bg-color: #2a0a18;
            --surface-color: rgba(50, 10, 30, 0.6);
            --accent-color: #f472b6;
            /* Pink 400 */
        }

        body {
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, rgba(var(--accent-color), 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(255, 255, 255, 0.05) 0px, transparent 50%);
            color: var(--text-primary);
            transition: background-color 0.5s ease;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--surface-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass:hover {
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
        }

        .neo-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .neo-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .neo-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .neo-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .status-dot {
            box-shadow: 0 0 8px currentColor;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Animations */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-enter {
            animation: fade-in-up 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="theme-nexus antialiased font-sans min-h-screen selection:bg-accent selection:text-white overflow-x-hidden">

    <!-- Modal: Limits -->
    <div id="limit-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div
            class="relative glass rounded-2xl w-full max-w-lg p-8 shadow-2xl transform transition-all scale-100 opacity-100">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold tracking-tight">Traffic Shaping</h3>
                <button onclick="closeModal()" class="text-white/50 hover:text-white transition"><i
                        class="ri-close-line text-2xl"></i></button>
            </div>

            <div class="mb-6 p-4 rounded-lg bg-white/5 border border-white/10 font-mono text-sm">
                <p class="text-white/50 text-xs uppercase mb-1">Target Device</p>
                <div id="modal-ip" class="text-accent font-bold text-lg"></div>
            </div>

            <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="space-y-2">
                    <label class="text-xs uppercase font-bold tracking-wider text-white/70">Upload Limit</label>
                    <div class="relative">
                        <input type="number" id="limit-up" class="neo-input w-full p-3 rounded-lg font-mono text-center"
                            placeholder="0">
                        <span class="absolute right-3 top-3 text-xs text-white/30 font-mono">KB/s</span>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs uppercase font-bold tracking-wider text-white/70">Download Limit</label>
                    <div class="relative">
                        <input type="number" id="limit-down"
                            class="neo-input w-full p-3 rounded-lg font-mono text-center" placeholder="0">
                        <span class="absolute right-3 top-3 text-xs text-white/30 font-mono">KB/s</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="saveLimits()"
                    class="flex-1 bg-accent text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 hover:-translate-y-0.5 transition-all">
                    APPLY LIMITS
                </button>
            </div>

            <hr class="my-6 border-white/10">

            <h3 class="text-lg font-bold tracking-tight mb-4">Traffic Quota</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-white/70 font-bold">Daily Data Cap</span>
                    <span id="quota-status" class="font-mono text-accent">Unlimited</span>
                </div>
                <div class="relative">
                    <input type="number" id="quota-limit" class="neo-input w-full p-3 rounded-lg font-mono text-center"
                        placeholder="0">
                    <span class="absolute right-3 top-3 text-xs text-white/30 font-mono">MB</span>
                </div>
                <button onclick="saveQuota()"
                    class="w-full neo-btn py-2 text-sm text-white rounded-lg hover:bg-white/10 transition">SET
                    QUOTA</button>
                <p class="text-xs text-white/30 text-center">Set to 0 to disable quota.</p>
            </div>
        </div>
    </div>

    <!-- Modal: Schedule -->
    <div id="schedule-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeScheduleModal()">
        </div>
        <div
            class="relative glass rounded-2xl w-full max-w-lg p-8 shadow-2xl transform transition-all scale-100 opacity-100">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold tracking-tight">Time Rules</h3>
                <button onclick="closeScheduleModal()" class="text-white/50 hover:text-white transition"><i
                        class="ri-close-line text-2xl"></i></button>
            </div>

            <div class="mb-6 space-y-4">
                <div class="p-4 rounded-lg bg-white/5 border border-white/10 h-64 overflow-y-auto custom-scrollbar"
                    id="schedule-list">
                    <!-- Rules loaded here -->
                    <div class="text-center text-white/30 italic mt-10">No active rules</div>
                </div>
            </div>

            <div class="border-t border-white/10 pt-6">
                <h4 class="font-bold text-sm text-white/70 mb-4 uppercase">Add New Rule</h4>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs text-white/50 block mb-1">Start Time</label>
                        <input type="time" id="rule-start" class="neo-input w-full p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs text-white/50 block mb-1">End Time</label>
                        <input type="time" id="rule-end" class="neo-input w-full p-2 rounded">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-white/50 block mb-1">Target</label>
                    <select id="rule-target" class="neo-input w-full p-2 rounded bg-black">
                        <option value="ALL">All Devices</option>
                        <!-- JS will populate specific devices -->
                    </select>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-white/50 block mb-1">Days</label>
                    <div class="flex justify-between text-xs font-mono">
                        <label><input type="checkbox" class="days-cb" value="0"> M</label>
                        <label><input type="checkbox" class="days-cb" value="1"> T</label>
                        <label><input type="checkbox" class="days-cb" value="2"> W</label>
                        <label><input type="checkbox" class="days-cb" value="3"> T</label>
                        <label><input type="checkbox" class="days-cb" value="4"> F</label>
                        <label><input type="checkbox" class="days-cb" value="5"> S</label>
                        <label><input type="checkbox" class="days-cb" value="6"> S</label>
                    </div>
                </div>

                <button onclick="addScheduleRule()"
                    class="w-full bg-accent text-white font-bold py-3 rounded-lg shadow-lg hover:-translate-y-0.5 transition-all">
                    ADD RULE
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Hostname -->
    <div id="host-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeHostModal()"></div>
        <div
            class="relative glass rounded-2xl w-full max-w-lg p-8 shadow-2xl transform transition-all scale-100 opacity-100">
            <h3 class="text-2xl font-bold tracking-tight mb-6">Identify Device</h3>

            <div class="mb-6 p-4 rounded-lg bg-white/5 border border-white/10 font-mono text-sm">
                <p class="text-white/50 text-xs uppercase mb-1">Target IP</p>
                <div id="host-modal-ip" class="text-accent font-bold text-lg"></div>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-xs uppercase font-bold tracking-wider text-white/70">Detected Hostnames</label>
                    <span id="scan-status" class="text-xs font-mono text-accent animate-pulse"></span>
                </div>
                <div id="detected-hosts" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                    <!-- Dynamic buttons -->
                </div>

                <label class="text-xs uppercase font-bold tracking-wider text-white/70 block mt-4">Manual
                    Override</label>
                <input type="text" id="manual-host-input" class="neo-input w-full p-3 rounded-lg font-mono"
                    placeholder="Enter custom name...">
            </div>

            <div class="flex gap-3">
                <button onclick="deepScanHost()" id="btn-scan"
                    class="bg-white/10 text-white/50 hover:text-white hover:bg-white/20 font-mono font-bold py-3 px-4 rounded-lg transition-all"
                    title="Force Deep Scan">
                    <i class="ri-search-eye-line"></i>
                </button>
                <button onclick="saveHostname()"
                    class="flex-1 bg-accent text-white font-bold py-3 rounded-lg shadow-lg hover:-translate-y-0.5 transition-all">
                    SAVE IDENTITY
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: History -->
    <div id="history-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeHistoryModal()">
        </div>
        <div
            class="relative glass rounded-2xl w-full max-w-2xl p-8 shadow-2xl transform transition-all scale-100 opacity-100 flex flex-col max-h-[80vh]">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-2xl font-bold tracking-tight">Traffic History</h3>
                    <div id="history-modal-ip" class="text-accent font-mono text-sm mt-1"></div>
                </div>
                <button onclick="closeHistoryModal()" class="text-white/50 hover:text-white transition"><i
                        class="ri-close-line text-2xl"></i></button>
            </div>

            <div
                class="mb-4 bg-white/5 p-3 rounded-lg border border-white/5 text-xs text-white/50 flex items-center gap-2">
                <i class="ri-information-line text-accent"></i>
                <span>Only <strong>Domains</strong> (SNI) are visible. Full URL paths are encrypted by TLS and cannot be
                    seen.</span>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar bg-black/20 rounded-xl border border-white/5">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-surface backdrop-blur-md z-10 border-b border-white/10">
                        <tr class="text-xs font-bold text-white/40 uppercase tracking-wider">
                            <th class="p-4">Time</th>
                            <th class="p-4">Domain</th>
                        </tr>
                    </thead>
                    <tbody id="history-list" class="text-sm divide-y divide-white/5 font-mono">
                        <!-- Items -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Device Chart -->
    <div id="chart-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeChartModal()"></div>
        <div
            class="relative glass rounded-2xl w-full max-w-4xl p-6 shadow-2xl transform transition-all scale-100 opacity-100 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold tracking-tight">Real-time Traffic</h3>
                    <div id="chart-modal-ip" class="text-accent font-mono text-sm"></div>
                </div>
                <button onclick="closeChartModal()" class="text-white/50 hover:text-white transition"><i
                        class="ri-close-line text-2xl"></i></button>
            </div>
            <div class="flex-1 min-h-[400px] relative w-full bg-black/20 rounded-xl p-4 border border-white/5">
                <canvas id="deviceChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="max-w-[1600px] mx-auto p-4 md:p-8 space-y-6">

        <!-- Header -->
        <header
            class="glass rounded-2xl p-6 flex flex-col md:flex-row justify-between items-center gap-6 animate-enter">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-xl bg-accent/20 flex items-center justify-center text-accent shadow-[0_0_20px_rgba(var(--accent-color),0.3)]">
                    <i class="ri-radar-fill text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Evil Limits</h1>
                    <div class="flex items-center gap-2 text-sm text-white/50">
                        <span class="w-2 h-2 rounded-full bg-green-500 status-dot"></span>
                        <span id="status" class="font-mono">SYSTEM ONLINE</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-4">
                <!-- Refresh Rate -->
                <div class="flex items-center gap-2 bg-white/5 px-3 py-2 rounded-lg border border-white/5">
                    <i class="ri-timer-flash-line text-white/50"></i>
                    <input type="number" id="refresh-rate" value="1000" min="100" step="100"
                        onchange="updateRefreshRate(this.value)"
                        class="bg-transparent border-none text-right font-mono text-sm w-12 focus:outline-none text-accent"
                        title="Refresh Rate (ms)">
                    <span class="text-xs text-white/30">ms</span>
                </div>

                <!-- Theme Switcher -->
                <div class="flex p-1 bg-white/5 rounded-lg border border-white/5">
                    <button onclick="changeTheme('theme-nexus')" class="p-2 rounded hover:bg-white/10 text-cyan-400"
                        title="Nexus"><i class="ri-macbook-line"></i></button>
                    <button onclick="changeTheme('theme-cyber')" class="p-2 rounded hover:bg-white/10 text-green-400"
                        title="Cyber"><i class="ri-terminal-box-line"></i></button>
                    <button onclick="changeTheme('theme-sunset')" class="p-2 rounded hover:bg-white/10 text-pink-400"
                        title="Sunset"><i class="ri-fire-line"></i></button>
                </div>

                <!-- Stats Widget -->
                <div class="glass px-5 py-2 rounded-xl border-accent/20 text-center cursor-pointer hover:bg-white/5 transition"
                    onclick="openScheduleModal()">
                    <div class="text-2xl font-bold font-mono text-accent"><i class="ri-calendar-event-line"></i></div>
                    <div class="text-[10px] uppercase font-bold tracking-wider text-white/40">Schedule</div>
                </div>

                <div class="glass px-5 py-2 rounded-xl border-accent/20 text-center">
                    <div class="text-2xl font-bold font-mono text-accent" id="device-count">0</div>
                    <div class="text-[10px] uppercase font-bold tracking-wider text-white/40">Targets</div>
                </div>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Main Chart -->
            <div class="glass rounded-2xl p-6 lg:col-span-2 flex flex-col animate-enter" style="animation-delay: 0.1s;">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="ri-pulse-line text-accent"></i> Network Traffic
                    </h3>
                    <div class="flex gap-4 text-xs font-mono">
                        <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            Upload</span>
                        <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            Download</span>
                    </div>
                </div>
                <div class="flex-1 min-h-[250px] relative w-full">
                    <canvas id="bwChart"></canvas>
                </div>
            </div>

            <!-- Top Consumers -->
            <div class="glass rounded-2xl p-6 flex flex-col animate-enter" style="animation-delay: 0.2s;">
                <h3 class="font-bold mb-6 flex items-center gap-2">
                    <i class="ri-speed-mini-fill text-yellow-500"></i> Top Hogs
                </h3>
                <div id="top-consumers" class="space-y-4 overflow-y-auto pr-2 custom-scrollbar flex-1 max-h-[300px]">
                    <!-- Items -->
                </div>
            </div>
        </div>

        <!-- Warning Banner if Limits Active -->
        <div id="active-limits-banner"
            class="hidden animate-enter bg-red-500/10 border border-red-500/20 rounded-xl p-4 items-center justify-between text-red-200">
            <div class="flex items-center gap-3">
                <i class="ri-alarm-warning-fill text-red-500 text-xl"></i>
                <span class="font-bold">ACTIVE LIMITS ENFORCED</span>
                <span class="text-sm opacity-70 hidden md:inline">Traffic is being routed through user-space limiter.
                    Performance may be impacted.</span>
            </div>
            <button onclick="clearAllLimits()"
                class="text-xs bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white px-3 py-1.5 rounded-lg transition font-mono uppercase tracking-wide">
                Clear All
            </button>
        </div>

        <!-- Device Table -->
        <div class="glass rounded-2xl overflow-hidden animate-enter" style="animation-delay: 0.3s;">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-bold text-white/40 uppercase tracking-wider border-b border-white/5">
                            <th class="p-5 w-10">
                                <input type="checkbox" id="select-all" onclick="toggleSelectAll()"
                                    class="rounded bg-white/10 border-white/20 text-accent focus:ring-0 cursor-pointer">
                            </th>
                            <th class="p-5 cursor-pointer hover:text-accent transition" onclick="setSort('ip')">Target
                                <i class="ri-arrow-up-down-line ml-1 opacity-50"></i>
                            </th>
                            <th class="p-5 cursor-pointer hover:text-accent transition" onclick="setSort('hostname')">
                                Vendor / Host <i class="ri-arrow-up-down-line ml-1 opacity-50"></i></th>
                            <th class="p-5 cursor-pointer hover:text-accent transition" onclick="setSort('os')">
                                Fingerprint <i class="ri-arrow-up-down-line ml-1 opacity-50"></i></th>
                            <th class="p-5 text-right cursor-pointer hover:text-accent transition"
                                onclick="setSort('down_speed')">Download <i
                                    class="ri-arrow-up-down-line ml-1 opacity-50"></i></th>
                            <th class="p-5 text-right cursor-pointer hover:text-accent transition"
                                onclick="setSort('up_speed')">Upload <i
                                    class="ri-arrow-up-down-line ml-1 opacity-50"></i></th>
                            <th class="p-5 text-right cursor-pointer hover:text-accent transition"
                                onclick="setSort('total')">Total <i class="ri-arrow-up-down-line ml-1 opacity-50"></i>
                            </th>
                            <th class="p-5 text-left cursor-pointer hover:text-accent transition"
                                onclick="setSort('quota')">Quota <i class="ri-arrow-up-down-line ml-1 opacity-50"></i>
                            </th>
                            <th class="p-5 text-center">Controls</th>
                        </tr>
                    </thead>
                    <tbody id="device-list" class="text-sm divide-y divide-white/5">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div id="bulk-actions"
            class="fixed bottom-6 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-xl hidden items-center gap-4 animate-enter z-40 border-accent/20">
            <span class="text-white font-mono text-sm"><span id="selected-count" class="text-accent font-bold">0</span>
                selected</span>
            <div class="h-4 w-px bg-white/10"></div>
            <button onclick="openBulkLimitModal()"
                class="text-xs neo-btn px-3 py-1.5 rounded-lg text-white hover:text-accent transition flex items-center gap-2">
                <i class="ri-equalizer-line"></i> SET LIMIT
            </button>
            <button onclick="openBulkChartModal()"
                class="text-xs neo-btn px-3 py-1.5 rounded-lg text-white hover:text-cyan-400 transition flex items-center gap-2">
                <i class="ri-line-chart-line"></i> COMPARE
            </button>
            <button onclick="clearBulkLimits()"
                class="text-xs neo-btn px-3 py-1.5 rounded-lg text-white hover:text-red-400 transition flex items-center gap-2">
                <i class="ri-close-circle-line"></i> CLEAR LIMITS
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- State ---
        let currentSort = { field: 'total', dir: -1 };
        let devicesData = [];
        let updateInterval = null;
        let currentEditingIp = null;
        let currentHostIp = null;
        let limitsActive = false;
        let selectedIps = new Set();
        let deviceChart = null;
        let currentChartIps = [];

        // --- Utils ---
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        function formatSpeed(bytes) { return formatBytes(bytes) + '/s'; }

        function ipToLong(ip) {
            return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;
        }

        function getOsIcon(os) {
            os = (os || 'Unknown').toLowerCase();
            if (os.includes('win')) return '<i class="ri-windows-fill text-blue-400"></i>';
            if (os.includes('mac') || os.includes('ios') || os.includes('apple')) return '<i class="ri-apple-fill text-gray-300"></i>';
            if (os.includes('android')) return '<i class="ri-android-fill text-green-500"></i>';
            if (os.includes('linux')) return '<i class="ri-ubuntu-fill text-orange-500"></i>';
            return '<i class="ri-question-mark text-white/20"></i>';
        }

        // --- Theme ---
        function changeTheme(theme) {
            document.body.classList.remove('theme-nexus', 'theme-cyber', 'theme-sunset');
            document.body.classList.add(theme);

            // Update chart colors based on theme
            let accent = '#3b82f6';
            if (theme === 'theme-cyber') accent = '#00ff41';
            if (theme === 'theme-sunset') accent = '#f472b6';
            if (theme === 'theme-nexus') accent = '#06b6d4';
        }

        // --- Chart Config ---
        Chart.defaults.color = '#64748b';
        Chart.defaults.font.family = '"JetBrains Mono", monospace';
        const ctx = document.getElementById('bwChart').getContext('2d');

        // Gradient
        const gradientDown = ctx.createLinearGradient(0, 0, 0, 300);
        gradientDown.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); // Emerald 500
        gradientDown.addColorStop(1, 'rgba(16, 185, 129, 0)');

        const gradientUp = ctx.createLinearGradient(0, 0, 0, 300);
        gradientUp.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue 500
        gradientUp.addColorStop(1, 'rgba(59, 130, 246, 0)');

        const bwChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Download',
                        borderColor: '#10b981',
                        backgroundColor: gradientDown,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        data: [],
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Upload',
                        borderColor: '#3b82f6',
                        backgroundColor: gradientUp,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        data: [],
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function (context) {
                                return context.dataset.label + ': ' + formatSpeed(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return formatBytes(value) + '/s'; }
                        }
                    }
                }
            }
        });

        // --- Core Logic ---
        let eventSource = null;
        let currentRate = 1000;

        function startStream(rate = 1000) {
            currentRate = rate;
            if (eventSource) eventSource.close();

            console.log(`Starting stream with rate: ${rate}ms`);
            eventSource = new EventSource(`/events?rate=${rate}`);

            eventSource.onmessage = function (event) {
                const json = JSON.parse(event.data);
                handleData(json);
            };

            eventSource.onerror = function (err) {
                // Often triggered on reload or close, only show error if persistent
                if (eventSource.readyState === EventSource.CLOSED) return;
                console.error("SSE Error", err);
                document.getElementById('status').innerText = "DISCONNECTED";
                document.getElementById('status').className = "font-mono text-red-500 animate-pulse";
            };
        }

        // --- Features ---
        function updateRefreshRate(ms) {
            ms = parseInt(ms);
            if (ms < 100 || isNaN(ms)) ms = 100;
            startStream(ms);
        }

        // Initial
        startStream(1000);

        function handleData(json) {
            // Handle both old list format (just in case) and new object format
            let devices = [];
            let lag = -1;

            if (Array.isArray(json)) {
                devices = json;
            } else {
                devices = json.devices;
                lag = json.monitor_lag;
            }

            devicesData = devices;
            document.getElementById('device-count').innerText = devices.length;

            const statusEl = document.getElementById('status');
            const dotEl = document.querySelector('.status-dot');

            if (lag > 10) {
                statusEl.innerText = "NO TRAFFIC DETECTED";
                statusEl.className = "font-mono text-yellow-500 animate-pulse";
                dotEl.className = "w-2 h-2 rounded-full bg-yellow-500 status-dot animate-pulse";
            } else if (lag > 3) {
                statusEl.innerText = "HIGH LATENCY";
                statusEl.className = "font-mono text-orange-400";
                dotEl.className = "w-2 h-2 rounded-full bg-orange-400 status-dot";
            } else {
                statusEl.innerText = "SYSTEM ONLINE";
                statusEl.className = "font-mono text-green-400";
                dotEl.className = "w-2 h-2 rounded-full bg-green-500 status-dot";
            }

            renderTable();
            renderTopConsumers(devices);
            updateChart(devices);
        }

        // Initial start
        startStream();


        function updateChart(devices) {
            let totalDown = 0;
            let totalUp = 0;
            devices.forEach(d => { totalDown += d.down_speed; totalUp += d.up_speed; });

            const now = new Date().toLocaleTimeString();
            if (bwChart.data.labels.length > 50) {
                bwChart.data.labels.shift();
                bwChart.data.datasets.forEach(dS => dS.data.shift());
            }
            bwChart.data.labels.push(now);
            bwChart.data.datasets[0].data.push(totalDown);
            bwChart.data.datasets[1].data.push(totalUp);
            bwChart.update('none');

            updateDeviceChart(devices);
        }

        function renderTopConsumers(devices) {
            const container = document.getElementById('top-consumers');
            container.innerHTML = '';

            // Sort by TOTAL usage
            const sorted = [...devices]
                .sort((a, b) => (b.total_down + b.total_up) - (a.total_down + a.total_up))
                .slice(0, 5);

            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-white/20">
                        <i class="ri-radar-line text-4xl mb-2"></i>
                        <span class="text-xs uppercase">No Devices</span>
                    </div>`;
                return;
            }

            const maxUsage = Math.max(1, sorted[0].total_down + sorted[0].total_up);

            sorted.forEach(d => {
                const total = d.total_down + d.total_up;
                // Calculate percentage relative to the top hog
                const pct = (total / maxUsage) * 100;

                let name = d.hostname === 'Unknown' ? d.vendor || 'Unknown Device' : d.hostname;
                if (name.length > 20) name = name.substring(0, 20) + '...';

                const div = document.createElement('div');
                div.className = "group";
                div.innerHTML = `
                    <div class="flex justify-between text-xs mb-1.5 font-mono">
                        <span class="text-white/80 group-hover:text-white transition">${name}</span>
                        <span class="text-accent">${formatBytes(total)}</span>
                    </div>
                    <div class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-emerald-400 h-full rounded-full transition-all duration-700 ease-out relative" style="width: ${pct}%">
                            <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function safeId(ip) {
            return 'row-' + ip.replace(/\./g, '-');
        }

        function renderTable() {
            const tbody = document.getElementById('device-list');

            // Sort
            devicesData.sort((a, b) => {
                let valA, valB;
                switch (currentSort.field) {
                    case 'ip': valA = ipToLong(a.ip); valB = ipToLong(b.ip); break;
                    case 'hostname': valA = a.hostname || ""; valB = b.hostname || ""; break;
                    case 'total': valA = (a.total_down + a.total_up); valB = (b.total_down + b.total_up); break;
                    case 'os': valA = a.os || ""; valB = b.os || ""; break;
                    default: valA = a[currentSort.field]; valB = b[currentSort.field];
                }
                return (valA < valB ? -1 : 1) * currentSort.dir;
            });

            // Track IDs present in this update to potentially remove old ones
            const currentIps = new Set(devicesData.map(d => d.ip));

            devicesData.forEach(d => {
                const rowId = safeId(d.ip);
                let tr = document.getElementById(rowId);

                const isLimited = (d.limit_up > 0 || d.limit_down > 0);
                const isSelected = selectedIps.has(d.ip);
                const isOverQuota = d.quota_limit > 0 && (d.quota_used || 0) >= d.quota_limit;

                let rowClass = `group transition-colors border-b border-white/5 `;
                if (isOverQuota) {
                    // Stronger visual for quota exceeded
                    rowClass += 'bg-red-500/20 hover:bg-red-500/30 border-l-2 border-l-red-500 ';
                } else if (isLimited) {
                    rowClass += 'bg-red-500/5 hover:bg-red-500/10 '; // Lighter for limit
                } else {
                    rowClass += 'hover:bg-white/[0.02] ';
                }

                if (isSelected) rowClass += 'bg-accent/10 ';

                const limitUpInfo = d.limit_up > 0 ? `<span class="text-red-400 text-[10px] ml-1 opacity-70">/${d.limit_up}KB</span>` : '';
                const limitDownInfo = d.limit_down > 0 ? `<span class="text-red-400 text-[10px] ml-1 opacity-70">/${d.limit_down}KB</span>` : '';

                const downHtml = `${d.down_speed > 0 ? '↓ ' + formatSpeed(d.down_speed) : '<span class="text-white/10">-</span>'} ${limitDownInfo}`;
                const upHtml = `${d.up_speed > 0 ? '↑ ' + formatSpeed(d.up_speed) : '<span class="text-white/10">-</span>'} ${limitUpInfo}`;
                let totalText = formatBytes(d.total_down + d.total_up);

                // Quota display logic
                let quotaBadge = ''; // Goes in Target column

                if (d.quota_limit > 0) {
                    const qUsed = d.quota_used || 0;
                    const limitMB = Math.round(d.quota_limit / 1024 / 1024);
                    const usedMB = (qUsed / 1024 / 1024).toFixed(1); // One decimal for precision

                    const pct = Math.min(100, Math.round((qUsed / d.quota_limit) * 100));
                    const color = pct >= 100 ? 'text-red-500' : (pct >= 90 ? 'text-orange-500' : 'text-accent');

                    // Badge for Target Column
                    if (isOverQuota) {
                        quotaBadge = `<span class="inline-block mt-1 px-1.5 py-0.5 rounded bg-red-500/20 text-red-500 text-[10px] font-bold border border-red-500/30">QUOTA EXCEEDED</span>`;
                    } else {
                        quotaBadge = `<span class="inline-block mt-1 px-1.5 py-0.5 rounded bg-white/5 text-white/50 text-[10px] font-mono border border-white/10" title="Daily Quota">Limit: ${limitMB} MB</span>`;
                    }

                    // Total Column Details
                    if (qUsed >= d.quota_limit) {
                        totalText += `<div class="text-[10px] text-red-500 mt-1 font-bold"><i class="ri-error-warning-line"></i> ${usedMB} / ${limitMB} MB</div>`;
                    } else {
                        totalText += `<div class="text-[10px] ${color} mt-1 font-bold"><i class="ri-pie-chart-line"></i> ${usedMB} / ${limitMB} MB</div>`;
                    }
                }

                const hostDisplay = d.hostname !== 'Unknown'
                    ? `<div class="font-bold text-white group-hover:text-accent transition">${d.hostname}</div>`
                    : `<div class="text-white/40 italic">Unknown Device</div>`;

                const osIcon = getOsIcon(d.os);

                // SNI/Domains Tooltip (Clickable)
                let domainInfo = '';
                if (d.domains && d.domains.length > 0) {
                    domainInfo = `
                        <div class="flex items-center gap-2 ml-2">
                             <div class="group relative inline-block cursor-pointer" onclick="openHistoryModal('${d.ip}')">
                                 <i class="ri-eye-2-line text-xs text-white/30 hover:text-accent transition"></i>
                                 <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max p-2 bg-black/90 backdrop-blur rounded border border-white/10 text-xs text-white hidden group-hover:block z-50 shadow-xl pointer-events-none">
                                    <span class="font-bold text-accent">Quick View</span>
                                 </div>
                             </div>
                             <a href="/history/${d.ip}" target="_blank" class="group relative inline-block cursor-pointer text-decoration-none" onclick="event.stopPropagation()">
                                 <i class="ri-external-link-line text-xs text-white/30 hover:text-accent transition"></i>
                                 <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max p-2 bg-black/90 backdrop-blur rounded border border-white/10 text-xs text-white hidden group-hover:block z-50 shadow-xl pointer-events-none">
                                    <span class="font-bold text-accent">Open Log</span>
                                 </div>
                             </a>
                        </div>
                    `;
                }


                if (!tr) {
                    // Create New Row
                    tr = document.createElement('tr');
                    tr.id = rowId;
                    tr.className = rowClass;
                    tr.innerHTML = `
                        <td class="p-5">
                             <input type="checkbox" onclick="toggleSelect('${d.ip}')" ${isSelected ? 'checked' : ''} class="rounded bg-white/10 border-white/20 text-accent focus:ring-0 cursor-pointer">
                        </td>
                        <td class="p-5">
                            <div class="font-mono text-white/90 font-bold">${d.ip}</div>
                            <div class="text-[10px] uppercase text-white/30 tracking-wider font-mono">${d.mac}</div>
                            ${quotaBadge}
                        </td>
                        <td class="p-5">
                            <div class="flex items-center gap-2">
                                 <span class="host-cell">${hostDisplay}</span>
                                 <button onclick="openHostModal('${d.ip}')" class="text-xs opacity-0 group-hover:opacity-50 hover:!opacity-100 transition"><i class="ri-pencil-line"></i></button>
                            </div>
                            <div class="text-xs text-white/50">${d.vendor}</div>
                        </td>
                        <td class="p-5">
                            <div class="flex items-center gap-2 os-cell">
                                <span class="text-lg" title="${d.os}">${osIcon}</span>
                                <span class="text-xs text-white/40">${d.os}</span>
                                ${domainInfo}
                            </div>
                        </td>
                        <td class="p-5 text-right font-mono text-emerald-400 group-hover:text-emerald-300 transition down-cell">
                            ${downHtml}
                        </td>
                        <td class="p-5 text-right font-mono text-blue-400 group-hover:text-blue-300 transition up-cell">
                            ${upHtml}
                        </td>
                        <td class="p-5 text-right font-mono text-white/60 total-cell">
                            ${totalText}
                        </td>
                        <td class="p-5 text-center">
                            <div class="flex items-center justify-end gap-2 mb-2">
                                <!-- Graph Button -->
                                <button onclick="openChartModal('${d.ip}')"
                                    class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-cyan-400 transition" title="View Graph">
                                    <i class="ri-bar-chart-box-line"></i>
                                </button>
                                
                                <!-- Speed Limit Modal Button -->
                                <button onclick="openLimitModal('${d.ip}')"
                                    class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-white transition" title="Configure Limit">
                                    <i class="ri-equalizer-line ${isLimited ? 'text-accent' : ''}"></i>
                                </button>
                                
                                <!-- Captive Portal Toggle -->
                                <button onclick="toggleCaptivePortal('${d.ip}')" id="btn-captive-${ipToLong(d.ip)}"
                                    class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/50 hover:text-red-500 transition" title="Toggle Captive Portal">
                                    <i class="ri-door-lock-line"></i>
                                </button>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="performSingleLimit('${d.ip}', 30)" class="text-[10px] bg-white/5 hover:bg-white/10 border border-white/10 px-2 py-1 rounded font-mono transition text-white/40 hover:text-white">30</button>
                                <button onclick="performSingleLimit('${d.ip}', 100)" class="text-[10px] bg-white/5 hover:bg-white/10 border border-white/10 px-2 py-1 rounded font-mono transition text-white/40 hover:text-white">100</button>
                                <button onclick="performSingleLimit('${d.ip}', 0)" class="text-[10px] bg-white/5 hover:bg-white/10 border border-white/10 px-2 py-1 rounded font-mono transition text-white/40 hover:text-white" title="Unlimit">∞</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                } else {
                    // Update Existing
                    // Efficiently update only changed parts
                    if (tr.className !== rowClass) tr.className = rowClass;

                    // Update Target Cell (IP + Badge)
                    const targetCell = tr.children[1];
                    const targetHtml = `
                        <div class="font-mono text-white/90 font-bold">${d.ip}</div>
                        <div class="text-[10px] uppercase text-white/30 tracking-wider font-mono">${d.mac}</div>
                        ${quotaBadge}
                    `;
                    if (targetCell.innerHTML !== targetHtml) targetCell.innerHTML = targetHtml;

                    const downCell = tr.querySelector('.down-cell');
                    if (downCell.innerHTML !== downHtml) downCell.innerHTML = downHtml;

                    const upCell = tr.querySelector('.up-cell');
                    if (upCell.innerHTML !== upHtml) upCell.innerHTML = upHtml;

                    const osCell = tr.querySelector('.os-cell');
                    // Always re-render OS cell if complex tooltip updates
                    const newOsHtml = `
                                <span class="text-lg" title="${d.os}">${osIcon}</span>
                                <span class="text-xs text-white/40">${d.os}</span>
                                ${domainInfo}
                    `;
                    // Simple check to avoid flicker
                    // We can just set it
                    osCell.innerHTML = newOsHtml;

                    const totalCell = tr.querySelector('.total-cell');
                    if (totalCell.innerHTML !== totalText) totalCell.innerHTML = totalText;

                    // Update Checkbox state if needed (mostly handled by toggle click but good to sync)
                    const chk = tr.querySelector('input[type="checkbox"]');
                    if (chk.checked !== isSelected) chk.checked = isSelected;

                    // Ensure sort order by appending (moves it to the end of the list processed so far)
                    tbody.appendChild(tr);
                }
            });

            // Remove rows that are no longer present? 
            // User asked: "dont remove the devices which was recorded".
            // So we DO NOT remove children that were not touched.
            // BUT: If we re-sort, the old ones will bubble to the top (since we appended the active ones to bottom).
            // We might want to hide them or dim them?
            // Let's mark them as inactive.

            Array.from(tbody.children).forEach(child => {
                const ip = child.id.replace('row-', '').replace(/-/g, '.');
                if (!currentIps.has(ip)) {
                    // It's stale.
                    child.classList.add('opacity-30', 'grayscale');
                    // Move to bottom?
                    tbody.appendChild(child);
                } else {
                    child.classList.remove('opacity-30', 'grayscale');
                }
            });

            document.getElementById('select-all').checked = devicesData.length > 0 && devicesData.every(d => selectedIps.has(d.ip));
        }

        function setSort(field) {
            if (currentSort.field === field) {
                currentSort.dir *= -1;
            } else {
                currentSort.field = field;
                currentSort.dir = -1;
            }
            renderTable();
        }

        // --- Selection & Bulk Limits ---
        function toggleSelect(ip) {
            if (selectedIps.has(ip)) {
                selectedIps.delete(ip);
            } else {
                selectedIps.add(ip);
            }
            updateBulkUI();
            renderTable(); // Re-render to update checkboxes and highlighting
        }

        function toggleSelectAll() {
            const allSelected = devicesData.length > 0 && devicesData.every(d => selectedIps.has(d.ip));
            if (allSelected) {
                selectedIps.clear();
            } else {
                devicesData.forEach(d => selectedIps.add(d.ip));
            }
            updateBulkUI();
            renderTable();
        }

        function updateBulkUI() {
            const bar = document.getElementById('bulk-actions');
            const count = document.getElementById('selected-count');
            count.innerText = selectedIps.size;

            if (selectedIps.size > 0) {
                bar.classList.remove('hidden');
                bar.classList.add('flex');
            } else {
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
        }

        function openBulkLimitModal() {
            if (selectedIps.size === 0) return;

            // Re-use existing modal
            currentEditingIp = null; // Indicates bulk mode
            document.getElementById('modal-ip').innerHTML = `<span class="text-accent">${selectedIps.size}</span> devices selected`;
            document.getElementById('limit-up').value = 0;
            document.getElementById('limit-down').value = 0;

            const modal = document.getElementById('limit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function clearBulkLimits() {
            if (!confirm(`Remove limits for ${selectedIps.size} devices?`)) return;

            await performBulkLimit(0, 0);
        }

        async function performBulkLimit(up, down) {
            try {
                const res = await fetch('/api/limit/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ips: Array.from(selectedIps),
                        up: up,
                        down: down
                    })
                });
                const data = await res.json();

                limitsActive = data.active;
                updateLimitBanner();

                // Clear selection after success? Maybe keep it.
                // selectedIps.clear(); 
                // updateBulkUI(); 

                // Just trigger update to refresh UI
                update();

            } catch (e) {
                alert("Error setting limits: " + e);
            }
        }

        // --- Features ---
        function updateRefreshRate(ms) {
            ms = parseInt(ms);
            if (ms < 100 || isNaN(ms)) ms = 100;
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(update, ms);
        }

        function openLimitModal(ip) {
            currentEditingIp = ip;
            document.getElementById('modal-ip').innerText = ip;

            // Try to find current limit to pre-fill? 
            // We need to look at devicesData
            const dev = devicesData.find(d => d.ip === ip);
            if (dev) {
                document.getElementById('limit-up').value = dev.limit_up || 0;
                document.getElementById('limit-down').value = dev.limit_down || 0;
            } else {
                document.getElementById('limit-up').value = 0;
                document.getElementById('limit-down').value = 0;
            }

            // Load Quota
            loadQuota(ip);

            const modal = document.getElementById('limit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('limit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditingIp = null;
        }

        async function performSingleLimit(ip, val) {
            // Apply val to both up and down
            try {
                // Optimistic UI update could go here (e.g. show spinner on row)
                const res = await fetch('/api/limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, up: val, down: val })
                });
                const data = await res.json();
                limitsActive = data.active;
                updateLimitBanner();
                // No need to reload, SSE will update eventual consistency
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function saveLimits() {
            if (!currentEditingIp) return; // Should not happen if triggered by modal
            const up = parseInt(document.getElementById('limit-up').value) || 0;
            const down = parseInt(document.getElementById('limit-down').value) || 0;

            const btn = document.querySelector("#limit-modal button.bg-accent");
            const originalText = btn.innerText;
            btn.innerText = "APPLYING...";

            try {
                const res = await fetch('/api/limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: currentEditingIp, up: up, down: down })
                });
                const data = await res.json();
                limitsActive = data.active; // Update global state
                updateLimitBanner();
                closeModal();
            } catch (e) {
                alert("Error setting limits: " + e);
            } finally {
                btn.innerText = originalText;
            }
        }

        function updateLimitBanner() {
            const banner = document.getElementById('active-limits-banner');
            if (limitsActive) {
                banner.classList.remove('hidden');
                banner.classList.add('flex');
            } else {
                banner.classList.add('hidden');
                banner.classList.remove('flex');
            }
        }

        async function clearAllLimits() {
            // We can just reload page or ask user to restart, as before.
            // Or now we can actually implement it if we want, but for now stick to simple.
            // Actually, since we have the bulk logic, we can implement it cleanly if we want.
            // But the user didn't explicitly ask for "Clear All button to work", they asked for multi-device select.
            alert("Use bulk selection to clear limits for specific devices, or restart services to clear all.");
        }

        // --- Device Chart ---
        function openBulkChartModal() {
            if (selectedIps.size === 0) return;
            openChartModal(Array.from(selectedIps));
        }

        function openChartModal(ipOrList) {
            const ips = Array.isArray(ipOrList) ? ipOrList : [ipOrList];
            if (ips.length === 0) return;

            currentChartIps = ips;

            if (ips.length === 1) {
                const d = devicesData.find(d => d.ip === ips[0]);
                document.getElementById('chart-modal-ip').innerText = `${ips[0]} (${d ? d.hostname : 'Unknown'})`;
            } else {
                document.getElementById('chart-modal-ip').innerText = `${ips.length} Targets Selected`;
            }

            const modal = document.getElementById('chart-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            initDeviceChart();
        }

        function closeChartModal() {
            const modal = document.getElementById('chart-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // Clear chart data but don't nullify ips yet so we don't crash async updates immediately
            currentChartIps = [];
            if (deviceChart) {
                deviceChart.destroy();
                deviceChart = null;
            }
        }

        function initDeviceChart() {
            if (deviceChart) deviceChart.destroy();

            const datasets = [];
            currentChartIps.forEach((ip, idx) => {
                // Generate distinctive colors
                // Use Golden Angle to separate hues
                const hue = (idx * 137.508) % 360;
                const color = `hsla(${hue}, 80%, 60%, 1)`;

                // Down
                datasets.push({
                    label: `${ip} ↓`,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    data: []
                });

                // Up (Dashed)
                datasets.push({
                    label: `${ip} ↑`,
                    borderColor: color,
                    borderDash: [4, 4],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    data: []
                });
            });

            const ctx2 = document.getElementById('deviceChartCanvas').getContext('2d');
            deviceChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, labels: { color: '#94a3b8', font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + formatSpeed(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            beginAtZero: true,
                            ticks: { callback: function (value) { return formatBytes(value) + '/s'; }, color: '#64748b' }
                        }
                    }
                }
            });
        }

        function updateDeviceChart(devices) {
            if (!currentChartIps || currentChartIps.length === 0 || !deviceChart) return;

            const now = new Date().toLocaleTimeString();

            if (deviceChart.data.labels.length > 50) {
                deviceChart.data.labels.shift();
                deviceChart.data.datasets.forEach(ds => ds.data.shift());
            }

            deviceChart.data.labels.push(now);

            currentChartIps.forEach((ip, idx) => {
                const d = devices.find(x => x.ip === ip) || { down_speed: 0, up_speed: 0 };
                // Datasets are packed [Down, Up, Down, Up...]
                if (deviceChart.data.datasets[2 * idx]) deviceChart.data.datasets[2 * idx].data.push(d.down_speed);
                if (deviceChart.data.datasets[2 * idx + 1]) deviceChart.data.datasets[2 * idx + 1].data.push(d.up_speed);
            });

            deviceChart.update('none');
        }

        // --- Hostname Features ---
        function openHostModal(ip) {
            currentHostIp = ip;
            const device = devicesData.find(d => d.ip === ip);
            if (!device) return;

            document.getElementById('host-modal-ip').innerText = ip;
            document.getElementById('manual-host-input').value = device.hostname !== 'Unknown' ? device.hostname : '';

            const list = document.getElementById('detected-hosts');
            list.innerHTML = '';

            const names = device.possible_names || [];
            if (names.length === 0) {
                list.innerHTML = '<div class="text-white/20 italic text-sm">No hostnames detected via DNS/mDNS</div>';
            } else {
                names.forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 rounded bg-white/5 hover:bg-white/10 text-sm font-mono transition flex items-center gap-2";
                    btn.innerHTML = `<i class="ri-server-line text-accent"></i> ${name}`;
                    btn.onclick = () => { document.getElementById('manual-host-input').value = name; };
                    list.appendChild(btn);
                });
            }

            const modal = document.getElementById('host-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeHostModal() {
            const modal = document.getElementById('host-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentHostIp = null;
        }

        // --- History Modal ---
        function openHistoryModal(ip) {
            const d = devicesData.find(d => d.ip === ip);
            if (!d) return;

            document.getElementById('history-modal-ip').innerText = `${d.ip} (${d.hostname})`;
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = '';

            // Handle both string list (legacy) and object list (new)
            const history = (d.domains || []).map(dom => {
                if (typeof dom === 'string') return { domain: dom, time: 0 };
                return dom;
            }).reverse(); // Newest first

            if (history.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="p-8 text-center text-white/20 italic">No history available</td></tr>`;
            } else {
                history.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-white/5 transition";

                    let timeStr = "-";
                    if (item.time > 0) {
                        const date = new Date(item.time * 1000);
                        timeStr = date.toLocaleTimeString();
                    }

                    row.innerHTML = `
                        <td class="p-4 text-white/40 border-b border-white/5 w-32 whitespace-nowrap">${timeStr}</td>
                        <td class="p-4 text-accent border-b border-white/5 break-all">${item.domain}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            const modal = document.getElementById('history-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeHistoryModal() {
            const modal = document.getElementById('history-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function addHostnameToList(name, source) {
            const list = document.getElementById('detected-hosts');
            const existing = Array.from(list.children).some(btn => btn.innerText.includes(name));
            if (existing) return;
            if (list.innerHTML.includes("No hostnames detected")) list.innerHTML = '';

            const btn = document.createElement('button');
            btn.className = "w-full text-left p-3 rounded bg-white/5 hover:bg-white/10 text-sm font-mono transition flex items-center gap-2 border-l-2 border-accent animate-enter";
            btn.innerHTML = `<i class="ri-server-line text-accent"></i> ${name} <span class="text-xs text-white/30 ml-auto">${source}</span>`;
            btn.onclick = () => { document.getElementById('manual-host-input').value = name; };
            list.insertBefore(btn, list.firstChild);
        }

        async function deepScanHost() {
            if (!currentHostIp) return;
            const btn = document.getElementById('btn-scan');
            const statusParams = document.getElementById('scan-status');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>';
            statusParams.innerText = "Initializing...";

            try {
                const response = await fetch('/api/resolve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: currentHostIp })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const msg = JSON.parse(line);
                            if (msg.type === 'status') {
                                statusParams.innerText = msg.message;
                            } else if (msg.type === 'result') {
                                addHostnameToList(msg.name, msg.source);
                            } else if (msg.type === 'done') {
                                statusParams.innerText = "Scan Complete";
                                setTimeout(() => statusParams.innerText = "", 3000);
                            }
                        } catch (e) { console.error("Parse error", e); }
                    }
                }
            } catch (e) {
                alert("Scan failed: " + e);
                statusParams.innerText = "Error";
            } finally {
                btn.innerHTML = originalIcon;
            }
        }

        async function saveHostname() {
            if (!currentHostIp) return;
            const name = document.getElementById('manual-host-input').value.trim();
            if (!name) return;

            try {
                await fetch('/api/hostname', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: currentHostIp, name: name })
                });
                closeHostModal();
                update(); // Refresh immediately
            } catch (e) {
                alert("Error saving hostname: " + e);
            }
        }

        // Init
        updateRefreshRate(1000);
        update();

        // --- Quota ---
        function loadQuota(ip) {
            fetch(`/api/quota/${ip}`)
                .then(r => r.json())
                .then(data => {
                    const limitInput = document.getElementById('quota-limit');
                    const statusEl = document.getElementById('quota-status');

                    if (data.quota_limit > 0) {
                        const limitMB = Math.round(data.quota_limit / 1024 / 1024);
                        limitInput.value = limitMB;

                        const usedMB = (data.bytes_used / 1024 / 1024).toFixed(1);
                        const pct = Math.min(100, Math.round((data.bytes_used / data.quota_limit) * 100));

                        statusEl.innerHTML = `<span class="${pct >= 100 ? 'text-red-500' : 'text-accent'}">${usedMB}MB / ${limitMB}MB (${pct}%)</span>`;
                    } else {
                        limitInput.value = '';
                        statusEl.innerText = "Unlimited";
                    }
                })
                .catch(err => {
                    console.error("Error loading quota", err);
                    document.getElementById('quota-status').innerText = "Error";
                });
        }

        function saveQuota() {
            if (!currentEditingIp) return;
            const limit = document.getElementById('quota-limit').value;

            // Find MAC
            const dev = devicesData.find(d => d.ip === currentEditingIp);
            if (!dev) return;

            fetch('/api/quota', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mac: dev.mac, limit_mb: limit })
            }).then(r => r.json()).then(res => {
                if (res.status === 'ok') {
                    // alert("Quota updated");
                    closeModal();
                    update();
                } else {
                    alert("Error updating quota");
                }
            });
        }

        // --- Schedule ---
        function openScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('hidden');
            document.getElementById('schedule-modal').classList.add('flex');

            // Populate Target Dropdown
            const select = document.getElementById('rule-target');
            // Keep "All Devices"
            select.innerHTML = '<option value="ALL">All Devices</option>';

            // Add known devices
            devicesData.forEach(d => {
                const name = d.hostname !== 'Unknown' ? d.hostname : d.ip;
                const opt = document.createElement('option');
                opt.value = d.mac;
                opt.innerText = `${name} (${d.ip})`;
                select.appendChild(opt);
            });

            loadScheduleRules();
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.add('hidden');
            document.getElementById('schedule-modal').classList.remove('flex');
        }

        function loadScheduleRules() {
            fetch('/api/schedule')
                .then(r => r.json())
                .then(rules => {
                    const list = document.getElementById('schedule-list');
                    list.innerHTML = '';
                    if (!rules || rules.length === 0) {
                        list.innerHTML = '<div class="text-center text-white/30 italic mt-10">No active rules</div>';
                        return;
                    }

                    rules.forEach(rule => {
                        const div = document.createElement('div');
                        div.className = "bg-black/20 p-3 rounded mb-2 flex justify-between items-center animate-enter";

                        // Parse days
                        const daysMap = ['M', 'T', 'W', 'T', 'F', 'S', 'S']; // 0=Mon
                        const daysStr = rule.days.split(',').map(d => daysMap[parseInt(d)]).join(' ');

                        div.innerHTML = `
                            <div>
                                <div class="font-bold text-sm text-white">${rule.start_time} - ${rule.end_time}</div>
                                <div class="text-xs text-white/50">${daysStr} • ${rule.target_mac === 'ALL' ? 'All Devices' : 'Specific Device'}</div>
                            </div>
                            <button onclick="deleteScheduleRule(${rule.id})" class="text-red-500 hover:text-red-400"><i class="ri-delete-bin-line"></i></button>
                        `;
                        list.appendChild(div);
                    });
                });
        }

        function addScheduleRule() {
            const start = document.getElementById('rule-start').value;
            const end = document.getElementById('rule-end').value;
            const target = document.getElementById('rule-target').value;

            // Get checked days
            const days = Array.from(document.querySelectorAll('.days-cb:checked')).map(cb => cb.value).join(',');

            if (!start || !end || !days) {
                alert("Please fill all fields");
                return;
            }

            fetch('/api/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: "Rule " + Date.now(), // Auto name for now
                    mac: target,
                    action: 'block', // Default to block
                    start: start,
                    end: end,
                    days: days
                })
            }).then(r => r.json()).then(res => {
                if (res.status === 'ok') {
                    loadScheduleRules();
                    // Clear inputs?
                } else {
                    alert("Error adding rule");
                }
            });
        }

        function deleteScheduleRule(id) {
            if (!confirm("Delete this rule?")) return;
            fetch(`/api/schedule/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(res => {
                    loadScheduleRules();
                });
        }

        // --- Captive Portal Logic ---
        async function toggleCaptivePortal(ip) {
            const btnId = `btn-captive-${ipToLong(ip)}`;
            const btn = document.getElementById(btnId);
            const icon = btn.querySelector('i');

            // Check state by class
            const isLocked = icon.classList.contains('text-red-500');
            const newState = !isLocked;

            // Optimistic UI update
            if (newState) {
                icon.classList.remove('ri-door-lock-line');
                icon.classList.add('ri-door-lock-fill', 'text-red-500');
            } else {
                icon.classList.remove('ri-door-lock-fill', 'text-red-500');
                icon.classList.add('ri-door-lock-line');
            }

            try {
                await fetch('/api/settings/captive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, enable: newState })
                });
            } catch (e) {
                console.error(e);
            }
        }
    </script>

    <!-- Footer Link -->
    <div class="fixed bottom-4 right-4 z-50 flex gap-2">
        <a href="/rules"
            class="text-[10px] font-mono text-white/30 hover:text-accent transition flex items-center gap-2 bg-black/50 backdrop-blur px-3 py-1.5 rounded-full border border-white/5">
            <i class="ri-shield-keyhole-line"></i> Manage Rules
        </a>
        <a href="/captive_portal" target="_blank"
            class="text-[10px] font-mono text-white/30 hover:text-accent transition flex items-center gap-2 bg-black/50 backdrop-blur px-3 py-1.5 rounded-full border border-white/5">
            <i class="ri-external-link-line"></i> Preview Portal
        </a>
    </div>
</body>

</html>